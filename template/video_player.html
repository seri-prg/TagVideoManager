<html>
<head>
	<link rel="icon" href="data:,">
	<link rel="stylesheet" href="./lib/treeview.css" />
<style>

#base_layout {
	display: flex;
	flex-direction: row;	/* 横並びに表示する */
	flex-wrap: nowrap;		/* 折り返えさない */
	width: 100%;
	height:100%;
}

#tag_list {
	position: relative;	/*相対配置*/
	border: 1px solid #999;
	overflow:auto;
	height: 100px;
}

#tag_checkList {
	display: flex;			/* この要素はflexコンテナとなり、子要素は自動的にflexアイテムとなる */
	flex-direction: row;	/* 横並びに表示する */
	flex-wrap: wrap;		/* 画面幅に収まらない場合は折り返す */
}


#video_area {
	flex: 1;
	display: flex;
	flex-direction: column;
	border: 1px solid #999;
}

#video_head_btn button{
	height:100%;
	vertical-align: top;
}

#video_area video{
	flex: 1;
	flex-shrink: 1;
	width:100%;
	height:100%;
	overflow:auto;
}


#play_menu {
	position: relative;	/*相対配置*/
	width: 200px;
	overflow-y: auto;
	overflow-x: hidden;
	border: 1px solid #999;
}

#play_point_loading {
	display: flex;
	text-align: center;
	width:100%;
	height:100%;
}

#play_point_loading img {
	margin: auto;
}


#tag_time_base {
  margin: 0;
  padding: 0;
}

.play_rect {
	position: relative;
}

.play_rect img {
	border-color: red;
	left:0;
}

.play_rect_time {
	position: absolute;
	bottom: 0;
	left: 3;
	background: rgba(30, 30, 123, 0.7);
	color: #FFF;
}



</style>
</head>
<body>
<script src="./lib/common.js" charset="UTF8"></script>
<script src="./lib/media_player.js" charset="UTF8"></script>
<script src="./lib/taglist.js" charset="UTF8"></script>
<script>

	// タグ追加ボタン押されたとき
	function OnAddTag(msg)
	{
		console.log("OnAddTag:" + msg);
		// 既存のチェック状態は維持しながら更新する
		RequestJson("{{root_url}}video_update_taglist.custom_text?at=" + msg, (json)=>
		{
			UpdateTagList("tag_checkList", json); // タグリスト更新
			updateTagFilter("tag_text", ".tag_parts");	// タグリストの表示状態を更新
			SetupBtnPlayPoint(".tag_parts", "video", OnAddPlayPoint); // プレイポイント追加ボタン
		});
	}

	// プレイポイント追加ボタン押下時
	function OnAddPlayPoint(elem, currentTime)
	{
		RequestUpdatePlayPoint("&t=" + elem.id + "&ti=" + currentTime);
	}

	// プレイポイント削除処理
	function OnRemovePlayPoint(opCode, removeId)
	{
		RequestUpdatePlayPoint("&"+opCode+"=" + removeId);
	}


	// プレイポイントの更新リクエスト
	function RequestUpdatePlayPoint(updateQuery)
	{
		RequestJson("{{root_url}}video_update_play_point.custom_text?mt={{file_id}}" + updateQuery, (json)=>
		{
			RemoveChildAll(document.getElementById("play_menu"));
			UpdatePlayPoint("play_menu", json); // プレイポイント更新

			SetupTreeView(".caret", ".nested", OnChangeTreeNode);	// tree view登録
			SetupPlayVideo(".play_btn", "video", "play_time", OnSelectPlayPoint);	// 再生位置登録
			HideElem("tag_remove");	// 削除ボタンをoff
		});
	}



	var lastSelectPoint = null;
	// 再生開始位置選択時
	function OnSelectPlayPoint(elem, currentTime)
	{
		if (lastSelectPoint != null)
		{
			lastSelectPoint.setAttribute("border", 0);
		}

		var name = elem.getAttribute("tag_name");
		var dispTime = elem.getAttribute("play_disp");
		elem.setAttribute("border", "5px");
		lastSelectPoint = elem;

		// タグの削除
		UpdatePlayPointRemoveBtn("tag_remove", "rl", "{{tw_RemoveTag}}[" + name + "/" + dispTime+ "]", elem.id);
	}


	// treeviewのノード開閉時
	function OnChangeTreeNode(nodeElem)
	{
		// タグ全体を削除
		UpdatePlayPointRemoveBtn("tag_remove", "rla","{{tw_delAll}}[" + nodeElem.textContent+ "]", nodeElem.id);

		console.log("remove tag_id:" + nodeElem.id);
	}

	// 動画を管理から外す
	function OnRemoveVideo()
	{
		window.location.href = './{{list_url}}?rv={{file_id}}';
	}


	// タグリスト初期値
	const initJsonStr = `{{initTagString}}`;

	function UpdateTagList(targetId, jsonData)
	{
		var target = document.getElementById(targetId);
		RemoveChildAll(target);

		jsonData.forEach(element => 
		{
			const tag = document.createElement('button');
			tag.className = "tag_parts";
			tag.id = element.tag_id;
			tag.innerText = element.name;
			target.appendChild(tag);
		});
	}


	function UpdatePlayPoint(targetId, jsonData)
	{
		var target = document.getElementById(targetId);
		const tagTimeBase = document.createElement("ul");
		tagTimeBase.id = "tag_time_base";

		// tag毎の処理
		jsonData.tag_list.forEach(element => 
		{
			const group = document.createElement('li');
			const caret = document.createElement('span');
			caret.className = "caret";
			caret.id = element.id;
			caret.innerText = element.name;
			const nested = document.createElement('ul');
			nested.className = "nested";
			nested.setAttribute("tag_name", element.name);

			// 時間ごとの処理
			element.time_list.forEach(t => 
			{
				if (t.second <= 0.0001)
					return;

				const play_rect = document.createElement('div');
				play_rect.className = "play_rect";

				const play_btn = document.createElement('img');
				play_btn.className = "play_btn";
				play_btn.id = t.id;
				play_btn.src="./"+ t.link_img;
				play_btn.setAttribute("tag_name", element.name);
				play_btn.setAttribute("play_time", t.second);
				play_btn.setAttribute("play_disp", t.disp);
				
				const play_rect_time = document.createElement('div');
				play_rect_time.className = "play_rect_time";
				play_rect_time.innerText = t.disp;

				play_rect.appendChild(play_btn);
				play_rect.appendChild(play_rect_time);
				nested.appendChild(play_rect);
				nested.appendChild(document.createElement("br"));
			});

			group.appendChild(caret);
			group.appendChild(nested);

			tagTimeBase.appendChild(group);
		});

		target.appendChild(tagTimeBase);
	}

	// サムネイル更新
	function UpdateThumbnail()
	{
		var v = document.getElementById("video");
		callHtml("{{root_url}}video_update.custom_text?mt={{file_id}}&tht=" + v.currentTime);
	}


	document.addEventListener('DOMContentLoaded', function() 
	{
		UpdateTagList("tag_checkList", JSON.parse(initJsonStr)); // タグリスト更新
		// UpdatePlayPoint("play_menu", JSON.parse(initPlayPointJsonStr)); // プレイポイント更新


		// 途中再生関係
		SetupTreeView(".caret", ".nested", OnChangeTreeNode);	// tree view登録
		SetupPlayVideo(".play_btn", "video", "play_time", OnSelectPlayPoint);	// 再生位置登録

		// タグ追加関係
		setupTagFilter("tag_text", ".tag_parts");		// タグのフィルタリング登録 
		setupTagAdd("tag_text", "tag_add", OnAddTag);	// タグ追加ボタン

		SetupBtnPlayPoint(".tag_parts", "video", OnAddPlayPoint); // プレイポイント追加ボタン
		SetupPlayPointRemoveBtn("tag_remove", OnRemovePlayPoint); // プレイポイント削除ボタン

		// 動画を管理から外す際の確認
		SetupConfirm("remove_video", "{{tw_RemoveMediaConfirm}}", OnRemoveVideo);

		SetupKeepVolume("video"); //ボリューム保存セットアップ


		// プレイポイントの更新リクエスト
		// 初回は処理が重いのでページ遷移してからリクエストかける。
		RequestUpdatePlayPoint("");

	}, false);

</script>
<title>Tag Video Manager</title>

<!-- ベース -->
<div id="base_layout">

<!-- 動画 -->
<div id="video_area" >
	<div id="video_head_btn">
		<button onclick="UpdateThumbnail()">{{tw_setThumbnail}}<!--サムネイルに設定--></button>
		<button onclick="callHtml('{{root_url}}{{file_id}}.direct_open')">{{file_path}}</button>
	</div>
	<video id="video" controls autoplay playsinline>
		<source class="video_source" src="{{file_id}}.custom_video">
		<source class="video_source" src="{{file_id}}.direct_video">
	</video>

	<!-- タグ登録ボタン -->
	<div id="tag_list">
		<input type="text" id="tag_text" ><button id="tag_add">{{tw_AddTag}}<!--タグの追加--></button><br><br>
		<div id="tag_checkList"><!-- ここにタグリスト展開 --></div>
	</div>
</div>

<!-- 途中再生 -->
<div id="play_menu">
	<!-- プレイポイントを展開 -->
	<div id="play_point_loading"><img src="loading-l-5.gif" /></div>
</div>
</div>

<br>
<button id="tag_remove"><!-- 削除ボタン --></button><br>
<button id ="remove_video" >{{tw_RemoveMedia}}<!--この動画を管理から外す--></button>
</body>
</html>
